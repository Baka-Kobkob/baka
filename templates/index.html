<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MENG TOPUP - Free Fire</title>
  <link rel="stylesheet" href="/static/ok.css" />
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img src="/static/images/logo.jpg" alt="Logo" />
    MENG TOPUP
  </header>

  <main>
    <section class="banner">
      <div class="game-title">
        <img src="/static/images/op.png" alt="Free Fire Logo" class="ff-logo" />
        <div>
          <h3 class="khmer-heading">Garena Free Fire</h3>
          <h3 class="khmer-heading subtitle">ទិញពេជ្រតម្លៃសមរម្យ! តាមរយៈ ID របស់អ្នក</h3>
        </div>
      </div>
    </section>

    <section class="user-input">
      <h3 class="khmer-heading">1. បញ្ចូលព័ត៌មាន</h3>
      <div class="input-row">
        <input type="number" id="idInput" placeholder="Player ID" oninput="this.value=this.value.replace(/[^0-9]/g,'');"/>
      </div>
      <button onclick="checkUsername()">Check Username</button>
      <div id="usernameDisplay"></div>
    </section>

    <section>
      <h3 class="khmer-heading">2. ជ្រើសរើសកញ្ចប់</h3>
      <div class="pricing-grid" id="packageGrid">
        </div>
    </section>

    <section>
      <h3 class="khmer-heading">3. ជ្រើសរើសការទូទាត់</h3>
      <div class="payment-card" id="khqrCard" onclick="toggleKhqrSelection()">
        <label for="khqrCheck">KHQR Payment</label>
        <p>Scan to pay with any banking app</p>
        <input type="checkbox" id="khqrCheck" onclick="event.stopPropagation()" />
      </div>
    </section>
    
    <button id="buyNowBtn" onclick="initiatePayment()">Buy Now $0.00</button>
  </main>

  <div class="modal" id="bakongModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">×</span>
      <h2 class="english-heading">KHQR Payment</h2>
      <div class="english-heading" id="bakongStatus">Ready to generate payment QR</div>
      <div class="qr-container">
        <div class="qr-image">
          <img alt="QR Code" id="bakongQR" src=""/>
        </div>
      </div>
      <div class="english-heading" id="bakongCountdown"></div>
      <div class="modal-buttons">
        <button class="bakong-btn khmer-heading" onclick="closeModal()">បោះបង់</button>
      </div>
    </div>
  </div>

  <div class="modal" id="invoiceModal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">×</span>
      <h2 class="english-heading">Payment Successful</h2>
      <div class="invoice-details">
        <div class="invoice-row">
          <span class="invoice-icon">👤</span>
          <span class="invoice-label english-heading">Username:</span>
          <span class="invoice-value english-heading" id="invoice-username"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">🆔</span>
          <span class="invoice-label english-heading">Player ID:</span>
          <span class="invoice-value english-heading" id="invoice-playerid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">🎮</span>
          <span class="invoice-label english-heading">Package:</span>
          <span class="invoice-value english-heading" id="invoice-package"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">💵</span>
          <span class="invoice-label english-heading">Amount:</span>
          <span class="invoice-value english-heading" id="invoice-amount"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">📅</span>
          <span class="invoice-label english-heading">Date:</span>
          <span class="invoice-value english-heading" id="invoice-date"></span>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="bakong-btn english-heading" onclick="backToTopup()">Back to Top-up</button>
      </div>
    </div>
  </div>

  <script>
    const packages = [
      // កញ្ចប់តម្លៃធម្មតា (Non-Promotion)
      { name: "100 Diamonds", price: 1.00, image: "ff-diamond-normal.png", type: "normal" },
      { name: "210 Diamonds", price: 2.00, image: "ff-diamond-normal.png", type: "normal" },
      { name: "530 Diamonds", price: 5.00, image: "ff-diamond-normal.png", type: "normal" },
      { name: "1080 Diamonds", price: 10.00, image: "ff-diamond-normal.png", type: "normal" },
      { name: "2200 Diamonds", price: 20.00, image: "ff-diamond-normal.png", type: "normal" },

      // កញ្ចប់ប្រម៉ូសិន (Promotion)
      { name: "120 Diamonds (PROMO)", price: 1.00, image: "ff-diamond-promo.png", type: "promo" },
      { name: "250 Diamonds (PROMO)", price: 2.00, image: "ff-diamond-promo.png", type: "promo" },
      { name: "Weekly Pass (PROMO)", price: 1.50, image: "ff-weekly-pass.png", type: "promo" },
    ];

    const grid = document.getElementById("packageGrid");
    const buyNowBtn = document.getElementById("buyNowBtn");
    let selectedPrice = 0;
    let selectedName = "";
    let currentTransaction = null;
    let countdownInterval = null;
    let paymentCheckInterval = null;

    // -------------------- Initialize Package Grid --------------------
    packages.forEach(pkg => {
      const card = document.createElement("div");
      card.className = "card";
      if (pkg.type === "promo") {
        card.classList.add("promo-card"); // Add a class for promotion styles
      }
      card.dataset.name = pkg.name;
      card.dataset.price = pkg.price;
      card.innerHTML = `
        <img src="/static/images/${pkg.image}" alt="${pkg.name}" />
        <h2>${pkg.name}</h2>
        <p class="new-price">$${pkg.price.toFixed(2)}</p>
      `;
      card.onclick = () => {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedPrice = pkg.price;
        selectedName = pkg.name;
        buyNowBtn.textContent = `Buy Now $${selectedPrice.toFixed(2)}`;
      };
      grid.appendChild(card);
    });

    // -------------------- Username Check --------------------
    async function checkUsername() {
      const id = document.getElementById('idInput').value.trim();
      const display = document.getElementById('usernameDisplay');
      if (!id) { display.textContent = "⚠️ សូមបញ្ចូល Player ID."; return; }
      display.textContent = "កំពុងពិនិត្យឈ្មោះ...";
      try {
        const url = `https://nang-ff-check-id.vercel.app/api/check-ff`;
        const res = await fetch(url);
        const data = await res.json();
        display.textContent = (data.success && data.name) ? `✅ ឈ្មោះ: ${data.name}` : "❌ ឈ្មោះមិនត្រឹមត្រូវ.";
      } catch {
        display.textContent = "⚠️ មានបញ្ហាក្នុងការពិនិត្យ.";
      }
    }

    // -------------------- Modal Controls --------------------
    function openModal() { document.getElementById('bakongModal').style.display = 'block'; }
    function closeModal() {
      document.getElementById('bakongModal').style.display = 'none';
      clearInterval(countdownInterval);
      stopAutoPaymentCheck();
      currentTransaction = null;
    }
    function closeInvoiceModal() { document.getElementById('invoiceModal').style.display = 'none'; }

    // -------------------- Payment --------------------
    async function initiatePayment() {
      const id = document.getElementById('idInput').value.trim();
      const khqr = document.getElementById('khqrCheck').checked;

      if (!id) { alert('សូមបំពេញ Player ID.'); return; }
      if (!selectedName) { alert('សូមជ្រើសរើសកញ្ចប់.'); return; }
      if (!khqr) { alert('សូមជ្រើសរើសការទូទាត់.'); return; }

      openModal();
      await generateBakongQR(id);
    }

    async function generateBakongQR(playerId) {
      try {
        const response = await fetch('/generate_qr', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ amount: selectedPrice, player_id: playerId, package: selectedName })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Failed to generate QR');

        currentTransaction = { id: result.transaction_id, amount: result.amount, expiry: new Date(result.expiry), playerId, package: selectedName };
        document.getElementById('bakongQR').src = `data:image/png;base64,${result.qr_image}`;
        document.getElementById('bakongStatus').textContent = `Scan to pay $${selectedPrice.toFixed(2)}`;
        
        startCountdown();
        startAutoPaymentCheck();

      } catch (error) {
        document.getElementById('bakongStatus').textContent = `Error: ${error.message}`;
        document.getElementById('bakongStatus').style.color = '#f44336';
        console.error(error);
      }
    }

    // -------------------- Countdown --------------------
    function startCountdown() {
      clearInterval(countdownInterval);
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
      if (!currentTransaction) return;
      const remaining = currentTransaction.expiry - new Date();
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        stopAutoPaymentCheck();
        document.getElementById('bakongCountdown').textContent = 'QR Code Expired';
        document.getElementById('bakongCountdown').style.color = '#f44336';
        document.getElementById('bakongStatus').textContent = 'QR expired. Please try again.';
        return;
      }
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      document.getElementById('bakongCountdown').textContent = `Expires in: ${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
      document.getElementById('bakongCountdown').style.color = (mins===0 && secs<30) ? '#f44336' : 'white';
    }

    // -------------------- Auto Payment Check --------------------
    function startAutoPaymentCheck() {
      stopAutoPaymentCheck();
      checkBakongPayment(); // initial check
      paymentCheckInterval = setInterval(checkBakongPayment, 5000);
    }

    function stopAutoPaymentCheck() {
      if (paymentCheckInterval) clearInterval(paymentCheckInterval);
      paymentCheckInterval = null;
    }

    // -------------------- Check Payment --------------------
    async function checkBakongPayment() {
      if (!currentTransaction) return;
      document.getElementById('bakongStatus').textContent = 'Checking payment...';

      try {
        const response = await fetch('/check_payment', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ transaction_id: currentTransaction.id })
        });
        const result = await response.json();

        if (result.status === 'PAID') {
          clearInterval(countdownInterval);
          stopAutoPaymentCheck();
          document.getElementById('bakongCountdown').textContent = 'Payment Received!';
          document.getElementById('bakongCountdown').style.color = '#4caf50';
          document.getElementById('bakongStatus').textContent = result.message;
          showInvoice(currentTransaction);
          setTimeout(closeModal, 500);
        } else if (result.status === 'EXPIRED') {
          clearInterval(countdownInterval);
          stopAutoPaymentCheck();
          document.getElementById('bakongCountdown').textContent = 'QR Code Expired';
          document.getElementById('bakongCountdown').style.color = '#f44336';
          document.getElementById('bakongStatus').textContent = result.message;
        } else {
          document.getElementById('bakongStatus').textContent = result.message;
        }
      } catch (error) {
        document.getElementById('bakongStatus').textContent = `Error: ${error.message}`;
        document.getElementById('bakongStatus').style.color = '#f44336';
        console.error(error);
      }
    }

    // -------------------- Invoice --------------------
    function showInvoice(transaction) {
      const now = new Date();
      let username = document.getElementById('usernameDisplay').textContent.replace('✅ ឈ្មោះ: ', '');
      document.getElementById('invoice-username').textContent = username || 'N/A';
      document.getElementById('invoice-playerid').textContent = transaction.playerId;
      document.getElementById('invoice-package').textContent = transaction.package;
      document.getElementById('invoice-amount').textContent = '$' + transaction.amount.toFixed(2);
      document.getElementById('invoice-date').textContent = now.toLocaleString();
      document.getElementById('invoiceModal').style.display = 'block';
    }

    // -------------------- Back to Topup --------------------
    function backToTopup() {
      closeInvoiceModal();
      document.getElementById('idInput').value = '';
      document.getElementById('usernameDisplay').textContent = '';
      document.getElementById('khqrCheck').checked = false;
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      buyNowBtn.textContent = 'Buy Now $0.00';
      window.scrollTo(0, 0);
    }

    // -------------------- Toggle Payment Checkbox --------------------
    function toggleKhqrSelection() {
        const khqrCard = document.getElementById('khqrCard');
        const khqrCheck = document.getElementById('khqrCheck');
        khqrCheck.checked = !khqrCheck.checked;
        khqrCard.classList.toggle('selected', khqrCheck.checked);
    }
  </script>
</body>
</html>
