<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MENG TOPUP - Mobile Legends</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img src="/static/images/logo.jpg" alt="Logo" />
    MENG TOPUP
  </header>

  <main>
    <section class="banner">
      <div class="game-title">
        <img src="/static/images/mlbb-logo1.png" alt="Mobile Legends Logo" class="ml1-logo" />
        <div>
          <h3 class="khmer-heading" style="margin: 0; padding: 0; border: none;">Mobile Legend BANG BANG</h3>
          <h3 class="khmer-heading" style="font-size: 1rem; margin: 5px 0 0 0; padding: 0; border: none;">á‘á·á‰á–áŸá‡áŸ’ášáá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™! áá¶á˜ášá™áŸˆ ID ášá”áŸáŸ‹á¢áŸ’á“á€</h3>
        </div>
      </div>
    </section>

    <section class="user-input">
      <h3 class="khmer-heading">1. á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“</h3>
      <div class="input-row">
        <input type="number" id="idInput" placeholder="Player ID" oninput="this.value=this.value.replace(/[^0-9]/g,'');"/>
        <input type="number" id="zoneInput" placeholder="Zone ID (e.g., 1234)" oninput="this.value=this.value.replace(/[^0-9]/g,'');"/>
      </div>
      <button onclick="checkUsername()">Check Username</button>
      <div id="usernameDisplay"></div>
    </section>

    <section>
      <h3 class="khmer-heading">2. á‡áŸ’ášá¾áŸášá¾áŸá€á‰áŸ’á…á”áŸ‹</h3>
      <div class="pricing-grid" id="packageGrid"></div>
    </section>

    <section>
      <h3 class="khmer-heading">3. á‡áŸ’ášá¾áŸášá¾áŸá€á¶ášá‘á¼á‘á¶ááŸ‹</h3>
      <div class="khqr-card" id="khqrCard" onclick="toggleKhqrSelection()">
        <div class="text-group">
          <label for="khqrCheck">KHQR Payment</label>
          <p>Scan to pay with any banking app</p>
        </div>
        <input type="checkbox" id="khqrCheck" onclick="event.stopPropagation()" />
      </div>
    </section>
    
    <section class="banner">
        <div class="game-title">
            <img src="/static/images/logo.jpg" alt="MENG TOPUP Logo" style="width: 50px; height: 50px;"/>
            <div>
              <h3 class="khmer-heading" style="margin: 0; padding: 0; border: none;">á áŸáá»á¢áŸ’áœá¸á‡áŸ’ášá¾áŸášá¾áŸ MENG TOPUP?</h3>
              <h4 class="khmer-heading" style="font-size: 0.9rem; font-weight: normal; margin: 5px 0 0 0; padding: 0; border: none; color: #ccc;">áá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™ áŸá»áœááŸ’áá·á—á¶á– á‘áŸ†á“á»á€á…á·ááŸ’á á“á·á„áŸáŸáœá¶á€á˜áŸ’á˜ášá áŸáŸà¸—à¸±à¸™à¹ƒà¸ˆ</h4>
            </div>
        </div>
    </section>
  </main>

  <button onclick="initiatePayment()" id="buyNowBtn">Buy Now $0.00</button>

<div id="bakongModal" class="payment-box">
  <span class="close" onclick="closeModal()">&times;</span>
  <h2>Pay with KHQR</h2>
  <div class="qr-card">
    <div class="qr-header">
      <img src="/static/images/khqr.jpg" alt="KHQR Logo" class="khqr-logo">
      <span>KHQR</span>
    </div>
    <div class="qr-content">
      <p class="store-name">MENG TOPUP</p>
      <p class="amount-display">$<span id="amountDisplay">0.00</span></p>
      <hr class="dashed-line">
      <div class="qr-container">
        <img id="bakongQR" src="khqr.jpg" alt="KHQR">
      </div>
    </div>
  </div>
  <button id="downloadBtn">Download QR</button>
  <p id="statusMessage"></p>
</div>

  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">&times;</span>
      <h2><span style="font-size: 1.5rem;">âœ…</span> Payment Successful</h2>
      <div class="invoice-details">
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ‘¤</span>
          <span class="invoice-label">Username:</span>
          <span class="invoice-value" id="invoice-username"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ†”</span>
          <span class="invoice-label">Player ID:</span>
          <span class="invoice-value" id="invoice-playerid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸŒ</span>
          <span class="invoice-label">Zone ID:</span>
          <span class="invoice-value" id="invoice-zoneid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ’</span>
          <span class="invoice-label">Package:</span>
          <span class="invoice-value" id="invoice-package"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ’µ</span>
          <span class="invoice-label">Amount:</span>
          <span class="invoice-value" id="invoice-amount"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ“…</span>
          <span class="invoice-label">Date:</span>
          <span class="invoice-value" id="invoice-date"></span>
        </div>
      </div>
      <button class="bakong-btn" onclick="backToTopup()" style="margin-top: 20px; width: 100%;">Back to Top-up</button>
    </div>
  </div>

  <script>
    const packages = [
      { name: "11", price: 0.01 }, { name: "22", price: 0.50 }, { name: "86", price: 1.25 },
      { name: "172", price: 2.45 }, { name: "257", price: 3.50 }, { name: "343", price: 4.63 },
      { name: "429", price: 5.70 }, { name: "514", price: 6.80 }, { name: "600", price: 7.90 },
      { name: "706", price: 9.10 }, { name: "792", price: 9.95 }, { name: "878", price: 12.10 },
      { name: "963", price: 12.10 }, { name: "1050", price: 13.40 }, { name: "1135", price: 14.42 },
      { name: "1412", price: 17.80 }, { name: "1584", price: 19.99 }, { name: "1755", price: 23.28 },
      { name: "1926", price: 24.89 }, { name: "2195", price: 27.37 }, { name: "2538", price: 31.60 },
      { name: "2901", price: 35.72 }, { name: "4394", price: 52.80 }, { name: "5532", price: 65.80 },
      { name: "6238", price: 77.15 }, { name: "6944", price: 85.50 }, { name: "8433", price: 0.00 },
      { name: "9288", price: 116.00 }, 
      { name: "Weekly", price: 1.40, image: "mlweekly.jpg" }, 
      { name: "2Weekly", price: 2.80, image: "mlweekly.jpg" },
      { name: "3Weekly", price: 4.20, image: "mlweekly.jpg" }, 
      { name: "4Weekly", price: 5.60, image: "mlweekly.jpg" }, 
      { name: "5Weekly", price: 7.00, image: "mlweekly.jpg" },
      { name: "Twilight", price: 7.35, image: "starlight.jpg" },
    ];

    const grid = document.getElementById("packageGrid");
    const buyNowBtn = document.getElementById("buyNowBtn");
    const khqrCheck = document.getElementById("khqrCheck");
    const khqrCard = document.getElementById("khqrCard");
    let selectedPrice = 0;
    let selectedName = "";
    let currentTransaction = null;
    let countdownInterval = null;

    // Initialize package grid
    packages.forEach(pkg => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.name = pkg.name;
      card.dataset.price = pkg.price;
      card.innerHTML = `
        <img src="/static/images/${pkg.image || 'diamond.jpg'}" alt="Diamond" />
        <h2>${pkg.name} ${pkg.name.includes('Weekly') ? 'Pass' : 'Diamonds'}</h2>
        <p class="new-price">$${pkg.price.toFixed(2)}</p>
      `;
      card.onclick = () => {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedPrice = pkg.price;
        selectedName = pkg.name;
        buyNowBtn.textContent = `Buy Now $${selectedPrice.toFixed(2)}`;
      };
      grid.appendChild(card);
    });

    function toggleKhqrSelection() {
        khqrCheck.checked = !khqrCheck.checked;
        khqrCard.classList.toggle('selected', khqrCheck.checked);
    }

    async function checkUsername() {
      const id = document.getElementById('idInput').value.trim();
      const zone = document.getElementById('zoneInput').value.trim();
      const display = document.getElementById('usernameDisplay');
      if (!id || !zone) {
        display.textContent = "âš ï¸ Please enter both Player ID and Zone ID.";
        return;
      }
      display.textContent = "Checking username...";
      try {
        const url = `https://api.isan.eu.org/nickname/ml?id=${encodeURIComponent(id)}&zone=${encodeURIComponent(zone)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.name) {
          display.textContent = `âœ… Username: ${data.name}`;
        } else {
          display.textContent = "âŒ Username not found.";
        }
      } catch (err) {
        display.textContent = "âš ï¸ Error fetching data.";
      }
    }

    function openModal() {
      document.getElementById('bakongModal').style.display = 'block';
      document.getElementById('amountDisplay').textContent = selectedPrice.toFixed(2);
      document.getElementById('countdownDisplay').textContent = '05:00';
      document.getElementById('statusMessage').textContent = '';
      document.getElementById('bakongQR').src = '';
    }

    function closeModal() {
      document.getElementById('bakongModal').style.display = 'none';
      if (countdownInterval) clearInterval(countdownInterval);
      currentTransaction = null;
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
    }

    function initiatePayment() {
      const id = document.getElementById('idInput').value.trim();
      const zone = document.getElementById('zoneInput').value.trim();
      const khqr = document.getElementById('khqrCheck').checked;
      
      if (!id || !zone) {
        alert('Please fill Player ID and Zone ID.');
        return;
      }
      
      if (!selectedName) {
        alert('Please select a package.');
        return;
      }
      
      if (!khqr) {
        alert('Please check KHQR payment method.');
        return;
      }
      
      openModal();
      generateBakongQR(id, zone);
    }

    async function generateBakongQR(playerId, zoneId) {
      const statusMessage = document.getElementById('statusMessage');
      statusMessage.textContent = "Generating QR code...";
      statusMessage.className = "";
      document.getElementById('buyNowBtn').disabled = true;

      try {
        const response = await fetch('/generate_qr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            amount: selectedPrice,
            player_id: playerId,
            zone_id: zoneId,
            package: selectedName
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to generate QR');
        }
        
        // Store current transaction
        currentTransaction = {
          id: result.transaction_id,
          amount: result.amount,
          expiry: new Date(result.expiry),
          playerId: playerId,
          zoneId: zoneId,
          package: selectedName
        };
        
        // Display QR code
        document.getElementById('bakongQR').src = `data:image/png;base64,${result.qr_image}`;
        
        // Update status
        statusMessage.textContent = "Scan to pay with any banking app.";
        statusMessage.className = "success";
        document.getElementById('downloadBtn').disabled = false;
        
        // Start countdown
        startCountdown();
        
      } catch (error) {
        statusMessage.textContent = `Error: ${error.message}`;
        statusMessage.className = "error";
        console.error(error);
      } finally {
        document.getElementById('buyNowBtn').disabled = false;
      }
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
      if (!currentTransaction) return;
      
      const now = new Date();
      const remaining = (currentTransaction.expiry - now) / 1000;
      const countdownDisplay = document.getElementById('countdownDisplay');

      if (remaining <= 0) {
        clearInterval(countdownInterval);
        countdownDisplay.textContent = 'QR Code Expired';
        countdownDisplay.style.color = '#dc3545';
        document.getElementById('statusMessage').textContent = 'QR expired. Please try again.';
        document.getElementById('downloadBtn').disabled = true;
        return;
      }
      
      const mins = Math.floor(remaining / 60);
      const secs = Math.floor(remaining % 60);
      const countdownText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      countdownDisplay.textContent = countdownText;
      countdownDisplay.style.color = (mins === 0 && secs < 30) ? '#dc3545' : '#ff0000';
    }

    function showInvoice(transaction) {
      const now = new Date();
      
      // Get username (remove the âœ… prefix if exists)
      let username = document.getElementById('usernameDisplay').textContent;
      if (username.includes('âœ… Username: ')) {
        username = username.replace('âœ… Username: ', '');
      }
      
      // Fill invoice details
      document.getElementById('invoice-username').textContent = username || 'N/A';
      document.getElementById('invoice-playerid').textContent = transaction.playerId;
      document.getElementById('invoice-zoneid').textContent = transaction.zoneId;
      document.getElementById('invoice-package').textContent = transaction.package;
      document.getElementById('invoice-amount').textContent = '$' + transaction.amount.toFixed(2);
      document.getElementById('invoice-date').textContent = now.toLocaleString();
      
      // Show invoice modal
      document.getElementById('invoiceModal').style.display = 'block';
    }

    function backToTopup() {
      closeInvoiceModal();
      
      // Reset form
      document.getElementById('idInput').value = '';
      document.getElementById('zoneInput').value = '';
      document.getElementById('usernameDisplay').textContent = '';
      khqrCheck.checked = false;
      khqrCard.classList.remove('selected');
      
      // Reset package selection
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      selectedPrice = 0;
      selectedName = "";
      buyNowBtn.textContent = 'Buy Now $0.00';
      
      // Scroll to top
      window.scrollTo(0, 0);
    }
  </script>
</body>
</html>
