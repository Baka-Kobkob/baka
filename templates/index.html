<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MENG TOPUP - Free Fire</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <img src="/static/images/logo.jpg" alt="Logo" />
    MENG TOPUP
  </header>

  <main>
    <section class="banner">
      <div class="game-title">
        <img src="/static/images/op.png" alt="Free Fire Logo" class="ff-logo" />
        <div>
          <h3 class="khmer-heading">Garena Free Fire</h3>
          <h3 class="khmer-heading subtitle">ទិញពេជ្រតម្លៃសមរម្យ! តាមរយៈ ID របស់អ្នក</h3>
        </div>
      </div>
    </section>

    <section class="user-input">
      <h3 class="khmer-heading">1. បញ្ចូលព័ត៌មាន</h3>
      <div class="input-row">
        <input type="number" id="idInput" placeholder="Player ID" oninput="this.value=this.value.replace(/[^0-9]/g,'');"/>
      </div>
      <button onclick="checkUsername()">Check Username</button>
      <div id="usernameDisplay"></div>
    </section>

    <section>
      <h3 class="khmer-heading">2. ជ្រើសរើសកញ្ចប់</h3>
      <div class="pricing-grid" id="packageGrid">
        </div>
    </section>

    <section>
      <h3 class="khmer-heading">3. ជ្រើសរើសការទូទាត់</h3>
      <div class="payment-card" id="khqrCard" onclick="toggleKhqrSelection()">
        <label for="khqrCheck">KHQR Payment</label>
        <p>Scan to pay with any banking app</p>
        <input type="checkbox" id="khqrCheck" onclick="event.stopPropagation()" />
      </div>
    </section>
    
    <button id="buyNowBtn" onclick="initiatePayment()">Buy Now $0.00</button>
  </main>

  <div class="modal" id="bakongModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">×</span>
      <h2 class="english-heading">KHQR Payment</h2>
      <div class="english-heading" id="bakongStatus">Ready to generate payment QR</div>
      <div class="qr-container">
        <div class="qr-image">
          <img alt="QR Code" id="bakongQR" src=""/>
        </div>
      </div>
      <div class="english-heading" id="bakongCountdown"></div>
      <div class="modal-buttons">
        <button class="bakong-btn khmer-heading" onclick="closeModal()">បោះបង់</button>
      </div>
    </div>
  </div>

  <div class="modal" id="invoiceModal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">×</span>
      <h2 class="english-heading">Payment Successful</h2>
      <div class="invoice-details">
        <div class="invoice-row">
          <span class="invoice-icon">👤</span>
          <span class="invoice-label english-heading">Username:</span>
          <span class="invoice-value english-heading" id="invoice-username"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">🆔</span>
          <span class="invoice-label english-heading">Player ID:</span>
          <span class="invoice-value english-heading" id="invoice-playerid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">🎮</span>
          <span class="invoice-label english-heading">Package:</span>
          <span class="invoice-value english-heading" id="invoice-package"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">💵</span>
          <span class="invoice-label english-heading">Amount:</span>
          <span class="invoice-value english-heading" id="invoice-amount"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">📅</span>
          <span class="invoice-label english-heading">Date:</span>
          <span class="invoice-value english-heading" id="invoice-date"></span>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="bakong-btn english-heading" onclick="backToTopup()">Back to Top-up</button>
      </div>
    </div>
  </div>
   <script>
const packages = [
  { name: "100 Diamonds", price: 1.00, image: "ff-diamond-normal.png", type: "normal" },
  { name: "210 Diamonds", price: 2.00, image: "ff-diamond-normal.png", type: "normal" },
  { name: "530 Diamonds", price: 5.00, image: "ff-diamond-normal.png", type: "normal" },
  { name: "1080 Diamonds", price: 10.00, image: "ff-diamond-normal.png", type: "normal" },
  { name: "120 Diamonds (PROMO)", price: 1.00, image: "ff-diamond-promo.png", type: "promo" }
];

const grid = document.getElementById("packageGrid");
const buyNowBtn = document.getElementById("buyNowBtn");
let selectedPrice = 0;
let selectedName = "";
let currentTransaction = null;
let countdownInterval = null;

// -------------------- Initialize Package Grid --------------------
packages.forEach(pkg => {
  const card = document.createElement("div");
  card.className = "card";
  if (pkg.type === "promo") card.classList.add("promo-card");
  card.dataset.name = pkg.name;
  card.dataset.price = pkg.price;
  card.innerHTML = `
    <img src="/static/images/${pkg.image}" alt="${pkg.name}" />
    <h2>${pkg.name}</h2>
    <p class="new-price">$${pkg.price.toFixed(2)}</p>
  `;
  card.onclick = () => {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedPrice = pkg.price;
    selectedName = pkg.name;
    buyNowBtn.textContent = `Buy Now $${selectedPrice.toFixed(2)}`;
  };
  grid.appendChild(card);
});

// -------------------- Username Check --------------------
async function checkUsername() {
  const id = document.getElementById('idInput').value.trim();
  const display = document.getElementById('usernameDisplay');
  if (!id) { display.textContent = "⚠️ សូមបញ្ចូល Player ID."; return; }
  display.textContent = "កំពុងពិនិត្យឈ្មោះ...";
  try {
    const url = `https://nang-ff-check-id.vercel.app/api/check-ff?id=${id}`;
    const res = await fetch(url);
    const data = await res.json();
    display.textContent = (data.success && data.name) ? `✅ ឈ្មោះ: ${data.name}` : "❌ ឈ្មោះមិនត្រឹមត្រូវ.";
  } catch {
    display.textContent = "⚠️ មានបញ្ហាក្នុងការពិនិត្យ.";
  }
}

// -------------------- Modal Controls --------------------
function openModal() { document.getElementById('bakongModal').style.display = 'block'; }
function closeModal() { document.getElementById('bakongModal').style.display = 'none'; clearInterval(countdownInterval); currentTransaction = null; }
function closeInvoiceModal() { document.getElementById('invoiceModal').style.display = 'none'; }

// -------------------- Countdown --------------------
function startCountdown(expiry) {
  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    const remaining = expiry - new Date();
    if (remaining <= 0) {
      clearInterval(countdownInterval);
      document.getElementById('bakongCountdown').textContent = 'QR Code Expired';
      document.getElementById('bakongStatus').textContent = 'QR expired. សូមព្យាយាមម្ដងទៀត.';
      return;
    }
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    document.getElementById('bakongCountdown').textContent = `Expires in: ${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
  }, 1000);
}

// -------------------- Auto Payment Check --------------------
function autoCheckPayment(md5Hash, amount, playerId, packageName) {
  const startTime = Date.now();
  const timeout = 180000; // 3 minutes
  const interval = setInterval(async () => {
    if (Date.now() - startTime > timeout) {
      clearInterval(interval);
      alert("❌ ការបង់ប្រាក់មិនទទួលបានក្នុង 3 នាទី។");
      return;
    }

    try {
      const response = await fetch(`https://limvisa.vercel.app/api/bakong/check_payment/?md5=${md5Hash}`);
      const data = await response.json();
      const status = data.status?.toUpperCase();

      if (status === "PAID") {
        clearInterval(interval);
        alert(`✅ Payment $${amount.toFixed(2)} ទទួលបានហើយ!`);
        showInvoice(playerId, packageName, amount);
      }

    } catch(err) {
      console.error("Error checking payment:", err);
    }
  }, 2000);
}

// -------------------- Show Invoice --------------------
function showInvoice(playerId, packageName, amount) {
  const now = new Date();
  const username = document.getElementById('usernameDisplay').textContent.replace('✅ ឈ្មោះ: ', '') || 'N/A';
  const invoiceHtml = `
    <div>Player ID: ${playerId}</div>
    <div>Username: ${username}</div>
    <div>Package: ${packageName}</div>
    <div>Amount: $${amount.toFixed(2)}</div>
    <div>Date: ${now.toLocaleString()}</div>
  `;
  document.getElementById('invoiceModal').innerHTML = invoiceHtml;
  document.getElementById('invoiceModal').style.display = 'block';
}

// -------------------- Initiate Payment --------------------
async function initiatePayment() {
  const playerId = document.getElementById('idInput').value.trim();
  if (!playerId) { alert('សូមបំពេញ Player ID.'); return; }
  if (!selectedName) { alert('សូមជ្រើសរើសកញ្ចប់.'); return; }

  openModal();
  const md5Hash = "fake-md5-for-demo"; // Replace with actual MD5 from backend
  const expiry = new Date(new Date().getTime() + 5*60000);
  document.getElementById('bakongQR').src = "/static/images/ff-diamond-normal.png";
  document.getElementById('bakongStatus').textContent = `Scan to pay $${selectedPrice.toFixed(2)}`;
  startCountdown(expiry);
  autoCheckPayment(md5Hash, selectedPrice, playerId, selectedName);
}
    </script>
</body>
</html>
